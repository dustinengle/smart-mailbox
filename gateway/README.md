# StreamIOT Kit 


## Description

The StreamIOT Kit, further referred to as the, is a gateway interface to IOT that integrates with the StreamIOT marketplace and Blocksafe blockchain.  Sensor information is accumulated and acted upon in the `kit` with control logic that brokers the flow of SenML information via MQTT to StreamIOT then Aurora.  


## Requirements

The following are general system requirements for running the `kit` on a sensor device or Raspberry Pi.

* Python 2 - installed by default in most common Linux distributions including Raspbian for the Pi.
* Linux (Recommended) - the `kit` can also be used on a macOS or Windows machine.
* Internet Connection - to download supporting modules for the `kit`.
* Disk Space - enough disk space to run the `kit`, `Redis`, and any sensor devices.
* Root Access - or the ability to install the required packages to run the `kit` and `Redis`.


## Installation

Once the `kit` is downloaded from the marketplace and extracted the supporting modules need to be installed, to do this please continue to __Setup__.

__Setup__

`./script/setup.sh` will check for `python pip` and install if not found.  If the system is not using `python 2.7` then an error will be displayed and the script will stop running.  The system will be updated and the required `python` modules will be installed along with `Redis` that acts as the communication layer between the `kit` and the connected sensors.

__Note:__ The setup script is intended for the Linux operating system but the commands within can be extracted as needed for other operating systems.


## Usage

An administration interface has been provided to allow interaction with the `kit` while it is running.

To use the administartion script run `python admin/admin.py` and follow the instructions on screen by selecting the menu `number`, a description of each menu option is presented below. 

__Menu Options:__

* `1. Check the status of the starter kit account.`
  * Returns the Connected and Registered statuses.
* `2. Send a test message to the starter kit.`
  * Send a test message to the `kit`, if the `kit` has been registered it should sign the message, then send to be signed again for multisign and posted on the blockchain.
* `3. Change the password for the starter kit.`
  * This will send a message to the `kit` to notify it to re-encrypt the secret data with the new password.
  * __You must restart the `kit` in order for the new password to be used.__
  * The administration script will close after the password change.
* `4. Transfer funds from the starter kit account to the user account.`
  * You will be prompted for an amount to send.
* `5. Merge the starter kit account with the user account, remaining balance will go back to the user account.`
  * This removes the `kit` account from the blockchain and the remaining balance is sent back to the user account.
* `6. Quit`
  * Close the administration area script.
  * This will not close the `kit`, to do that you must use `Ctrl+c` or other form of keyboard interrupt for the operating system.


## Structure

The `kit` should be used to broker sensor information between sensor devices, StreamIOT, and eventually Aurora.  

For an overview of the general structure of the `kit` please refer to the [Overview](docs/Overview.pdf) documentation.

__Root Files:__

* `.env` - stores the channels, device id, device key, debug status, and testnet status for the `kit` and sensors.
* `.env.template` - an example `.env` that should be copied `cp .env.tample .env` and modified.
* `main.py` - handles SIGINT and starts the controller.
* `secret.dat` - holds the encrypted secret key for the device account is used to sign transactions for posting to Aurora.

__Note:__ The `.env` is auto-generated by the Marketplace and should not be modified unless you know what you are doing.

__Admin:__ Provides a user interface to interact with the `kit`.

* `admin.py` - interacts with the user and publishes messages to `pubsub.py` on a special `admin` channel that will cause the `kit` to take actions based on chosen options.

__`kit`:__ The internal API and helper functions.

* `account.py` - handles the multi-signature account and is responsible for storing the encrypted secret key.
* `codec.py` - handles the encoding and decoding of messages passed using `pubsub.py`.
* `controller.py` - contains the logic and is the brain or glue between the different modules.
* `crypto.py` - contains the hashing and encryption methods used in the `kit`.
* `env.py` - loads the `.env` file into the system environment.
* `file.py` - reads and writes to files for the `kit`.
* `logger.py` - handles the logging of errors and debug info.
* `message.py` - the internal communication object that is use by the `kit` and sensors.
* `mqtt.py` - a `paho-mqtt` wrapper for use within the `kit`'s receiver and sender.
* `pubsub.py` - relays `message.py` messages between the sensors and `controller.py`.
* `receiver.py` - listens and passes incoming messages into the `controller.py` for handling.
* `sender.py` - sets the `mqtt` client and publishes messages to StreamIOT.
* `signer.py` - extends `account.py` and brokers messages from the `controller.py` for signing and account creation.
* `util.py` - provides the `ID()` and `JSON()` functions for use within the `kit`.
  
__Tools:__ Helper functions.

* `encrypt_secret.py` - takes a secret key and encrypts with the local machine ID then stores it in `secret.dat`.
* `sensor_test.py` - generates random sensor data and publishes to `pubsub.py`/`redis` for capture by the `controller.py`.


## Contributing

To begin, clone the repository `git clone https://bitbucket.org/pagarba/stream-kit-001.git` and open the project folder in your choice of IDE.

When contributing, please follow the current overall structure and the general standards used within the `kit`.  

A `.editorconfig` file has been included to help with the configuration of IDEs.  For more information please refer to [https://editorconfig.org/](https://editorconfig.org/).

## License

Please refer to the [License](LICENSE) file.
